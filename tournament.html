<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournoi | Circled Fight</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/tournament.css">
</head>
<body>

<header class="main-header">
    <div class="logo-container">
        <h1>Circled Fight <span class="tag">CF</span></h1>
    </div>
    <button id="hamburgerMenu" class="hamburger-menu" aria-controls="mobileHub" aria-expanded="false" aria-label="Ouvrir le menu">‚ò∞</button>
    <nav id="mobileHub" class="mobile-hub" aria-hidden="true">
        <ul>
            <li><a href="index.html">Accueil</a></li>
            <li><a href="dashboard.html">Scores MJ</a></li>
            <li><a href="br_dashboard.html">Scores BR</a></li>
            <li><a href="tournament.html">Tournoi du Week-end</a></li>
            <li><a href="members.html">Membres du Clan</a></li>
            <li><a href="join.html">Nous Rejoindre</a></li>
        </ul>
    </nav>
    <div id="mobileHubBackdrop" class="mobile-hub-backdrop" tabindex="-1" aria-hidden="true"></div>
</header>

<main>
    <div class="carousel" id="carousel">
        <span class="prev">&#10094;</span>
        <span class="next">&#10095;</span>
        <img src="img/MJ.png" class="active" alt="Affiche MJ">
        <img src="img/BR.png" alt="Affiche BR">
        <img src="img/HALLO.png" alt="Event Halloween">
    </div>

    <div class="rules-actions">
        <button class="rules-btn btn-red" id="openRulesBtn">
            üìú R√®gles Tournoi MJ
        </button>
        <button class="rules-btn btn-yellow" id="openElimRulesBtn">
            ‚ò†Ô∏è R√®gles √âliminatoires
        </button>
    </div>
    
    <div class="form-container">
        <h2>Inscription Tournoi</h2>
        
        <label for="pseudo">SOLDAT (Pseudo In-Game)</label>
        <input type="text" id="pseudo" placeholder="Ex: Angelos" required>

        <label for="mode">MISSION (Mode)</label>
        <select id="mode">
            <option value="MJ">Multijoueur (MJ)</option>
            <option value="BR">Battle Royale (BR)</option>
        </select>

        <label for="retard">RAPPORT (Retard / Commentaire)</label>
        <textarea id="retard" placeholder="Ex: Pr√©sent √† 21h10..." rows="2"></textarea>

        <button id="submitBtn" class="cta-submit">CONFIRMER L'INSCRIPTION</button>
    </div>

    <div id="inscrits">
        <div class="mode-card">
            <div class="mode-header">
                <h4>‚öîÔ∏è FRONT MJ</h4>
                <span class="count" id="countMJ">0</span>
            </div>
            <ul id="inscritsMJ" class="inscrits-list"></ul>
        </div>

        <div class="mode-card">
            <div class="mode-header">
                <h4>üéØ ZONE BR</h4>
                <span class="count" id="countBR">0</span>
            </div>
            <ul id="inscritsBR" class="inscrits-list"></ul>
        </div>
    </div>
</main>

<div id="customSuccessModal" class="custom-modal-overlay">
    <div class="success-box">
        <span class="success-icon">‚úÖ</span>
        <h3 class="success-title">MISSION ENREGISTR√âE</h3>
        <p class="success-msg">
            Merci de vous √™tre inscrit, Soldat.<br><br>
            Votre inscription peut prendre <strong>quelques minutes</strong> avant d'√™tre effective dans la liste.<br>
            Merci de patienter.
        </p>
        <button class="btn-success-close" onclick="closeSuccessModal()">ROMPEZ</button>
    </div>
</div>

<div id="rulesModal" class="rules-modal">
        <div class="modal-content-rules">
        <span class="rules-close" onclick="closeModal('rulesModal')">&times;</span>
        <img src="img/regle.png" alt="R√®gles Tournoi"> 
    </div>
</div>
<div id="elimModal" class="rules-modal">
    <div class="modal-content-rules">
        <span class="rules-close" onclick="closeModal('elimModal')">&times;</span>
        <img src="img/elim.png" alt="R√®gles √âliminatoires"> 
    </div>
</div>

<script>
// --- Hamburger menu (Ton code original) ---
(function(){
    const btn = document.getElementById('hamburgerMenu');
    const hub = document.getElementById('mobileHub');
    const backdrop = document.getElementById('mobileHubBackdrop');
    function openHub() {
        hub.classList.add('open'); backdrop.classList.add('visible');
        btn.setAttribute('aria-expanded','true'); hub.setAttribute('aria-hidden','false');
    }
    function closeHub() {
        hub.classList.remove('open'); backdrop.classList.remove('visible');
        btn.setAttribute('aria-expanded','false'); hub.setAttribute('aria-hidden','true');
    }
    btn.addEventListener('click', ()=>{ hub.classList.contains('open') ? closeHub() : openHub(); });
    backdrop.addEventListener('click', closeHub);
})();

// --- Carrousel (Ton code original) ---
const carousel = document.getElementById('carousel');
const slides = carousel.querySelectorAll('img');
let current = 0;
function showSlide(index){
    slides.forEach(img => img.classList.remove('active'));
    slides[index].classList.add('active');
}
carousel.querySelector('.prev').addEventListener('click', ()=>{ current = (current -1 + slides.length)%slides.length; showSlide(current); });
carousel.querySelector('.next').addEventListener('click', ()=>{ current = (current +1)%slides.length; showSlide(current); });
let startX = 0;
carousel.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
carousel.addEventListener('touchend', e => {
    let endX = e.changedTouches[0].clientX;
    if(endX - startX > 50) current = (current -1 + slides.length)%slides.length;
    else if(startX - endX > 50) current = (current +1)%slides.length;
    showSlide(current);
});

// --- Modales R√®gles ---
const rulesModal = document.getElementById('rulesModal');
const elimModal = document.getElementById('elimModal');
document.getElementById('openRulesBtn').onclick = () => rulesModal.style.display = "block";
document.getElementById('openElimRulesBtn').onclick = () => elimModal.style.display = "block";
window.closeModal = (id) => document.getElementById(id).style.display = "none";
window.onclick = (e) => {
    if (e.target == rulesModal) rulesModal.style.display = "none";
    if (e.target == elimModal) elimModal.style.display = "none";
}

// --- GESTION DU SUCC√àS (Custom Pop-up) ---
function showSuccessModal() {
    document.getElementById('customSuccessModal').style.display = 'flex';
}
function closeSuccessModal() {
    document.getElementById('customSuccessModal').style.display = 'none';
}

// --- Formulaire Google Forms ---
const submitBtn = document.getElementById('submitBtn');
const entryPseudo = 'entry.1892682717';
const entryMode = 'entry.2094814093';
const entryComment = 'entry.125117687';
const formUrl = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSf_X1vZ1OO0yDvAtZOn1GfBYr8BqhRjLmakvVDsDVrwkte5dQ/formResponse';

submitBtn.onclick = ()=>{
    const pseudo = document.getElementById('pseudo').value.trim();
    const mode = document.getElementById('mode').value;
    const retard = document.getElementById('retard').value.trim();

    if(!pseudo){ alert("Merci de rentrer votre pseudo."); return; }

    // Effet visuel sur le bouton
    const originalText = submitBtn.innerText;
    submitBtn.innerText = "ENVOI EN COURS...";
    submitBtn.style.opacity = "0.7";

    const formData = new FormData();
    formData.append(entryPseudo, pseudo);
    formData.append(entryMode, mode);
    formData.append(entryComment, retard);

    fetch(formUrl,{method:'POST', mode:'no-cors', body:formData})
        .then(()=>{ 
            // ICI ON AFFICHE LA MODALE PERSONNALIS√âE AU LIEU DE L'ALERT
            showSuccessModal();

            // Reset
            document.getElementById('pseudo').value=''; 
            document.getElementById('retard').value='';
            submitBtn.innerText = originalText;
            submitBtn.style.opacity = "1";
            
            setTimeout(loadInscrits, 2000); 
        })
        .catch(()=>{
            alert("Erreur lors de l'inscription. V√©rifiez votre connexion.");
            submitBtn.innerText = originalText;
            submitBtn.style.opacity = "1";
        });
};

// --- Parseur CSV & Load ---
function parseCSV(text) {
    const rows = []; let cur = []; let field = ''; let inQuotes = false;
    for (let i = 0; i < text.length; i++) {
        const c = text[i]; const nc = text[i + 1];
        if (c === '"') { if (inQuotes && nc === '"') { field += '"'; i++; continue; } inQuotes = !inQuotes; continue; }
        if (c === '\r') continue;
        if (c === '\n' && !inQuotes) { cur.push(field); rows.push(cur); cur = []; field = ''; continue; }
        if (c === ',' && !inQuotes) { cur.push(field); field = ''; continue; }
        field += c;
    }
    if (field !== '' || cur.length) { cur.push(field); rows.push(cur); }
    return rows;
}

async function loadInscrits() {
    const mj = document.getElementById('inscritsMJ');
    const br = document.getElementById('inscritsBR');
    const countMJ = document.getElementById('countMJ');
    const countBR = document.getElementById('countBR');

    mj.innerHTML = '<li>Chargement...</li>';
    br.innerHTML = '<li>Chargement...</li>';

    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS59wx288NLzRRXUDs-6FFWdQxp2XX0FiwNyI2lnOOulTFORfqwA3SmoI7KHjuBvwDVW5J-QQ1GClHV/pub?output=csv';

    try {
        const res = await fetch(sheetUrl);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const rows = parseCSV(text);
        
        mj.innerHTML = ''; br.innerHTML = '';

        if (!rows || rows.length <= 1) {
            mj.innerHTML = '<li>Aucun inscrit</li>'; br.innerHTML = '<li>Aucun inscrit</li>';
            return;
        }

        const header = rows[0].map(h => (h || '').toString().trim().replace(/^"|"$/g, '').toLowerCase());
        let pseudoIdx = header.findIndex(h => /pseudo|player|name|nom/.test(h));
        let modeIdx = header.findIndex(h => /mode|type|gamemode/.test(h));
        if (pseudoIdx === -1) pseudoIdx = 0;
        if (modeIdx === -1) modeIdx = 1;

        let nbMJ = 0; let nbBR = 0;

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;
            const pseudo = (row[pseudoIdx] || '').toString().trim().replace(/^"|"$/g, '');
            const mode = (row[modeIdx] || '').toString().trim().replace(/^"|"$/g, '').toUpperCase();
            if (!pseudo) continue;

            const li = document.createElement('li');
            li.innerHTML = `<span style="color:#666; margin-right:8px;">‚ñ∏</span> ${pseudo}`;

            if (mode === 'MJ') { mj.appendChild(li); nbMJ++; }
            else if (mode === 'BR') { br.appendChild(li); nbBR++; }
            else { mj.appendChild(li); }
        }
        countMJ.textContent = nbMJ; countBR.textContent = nbBR;

    } catch (err) {
        mj.innerHTML = '<li>Erreur chargement</li>';
        br.innerHTML = '<li>Erreur chargement</li>';
    }
}
loadInscrits();
</script>

</body>
</html>	