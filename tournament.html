<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tournoi | Circled Fight</title>
<link rel="stylesheet" href="css/tournament.css">
<style>
/* --- Carrousel --- */
.carousel { position: relative; width: 100%; max-width: 600px; margin: 20px auto; overflow: hidden; border-radius: 10px; }
.carousel img { width: 100%; display: none; }
.carousel img.active { display: block; }

/* --- Fl√®ches du carrousel --- */
.carousel .prev, .carousel .next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 2rem;
    color: white;
    background: rgba(0,0,0,0.4);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    line-height: 36px;
    text-align: center;
    cursor: pointer;
    user-select: none;
    z-index: 10; /* Au-dessus de l'image */
}
.carousel .prev { left: 10px; }
.carousel .next { right: 10px; }

/* --- Formulaire --- */
.form-container { max-width: 600px; margin: 20px auto; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background: #1b1b1b; color: white; }
.form-container label { display: block; margin-top: 10px; }
.form-container input, .form-container select, .form-container textarea, .form-container button { width: 100%; margin-top: 5px; padding: 8px; border-radius: 5px; border: 1px solid #555; background: #121212; color: white; }
.form-container button { background: #ffc107; color: black; border: none; cursor: pointer; margin-top: 15px; }

/* --- Liste des inscrits --- */
#inscrits { max-width: 600px; margin: 20px auto; }
.mode-card { background: #111; border: 1px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 10px rgba(255,193,7,0.1); }
.mode-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
.mode-header .icon { font-size: 1.4rem; }
.mode-header h4 { margin: 0; font-size: 1.2rem; color: #ffc107; }
.inscrits-list { list-style: none; padding: 0; margin-top: 10px; }
.inscrits-list li { padding: 6px 0; border-bottom: 1px solid #444; color: #ddd; }


/* ================================================= */
/* --- NOUVEAUX STYLES : Bouton et Modale R√®gles --- */
/* ================================================= */

.rules-button {
    display: block;
    width: 90%;
    max-width: 600px;
    margin: 20px auto 30px auto;
    padding: 12px;
    background-color: #FF2344; /* Rouge visible */
    color: white;
    border: 2px solid #ffc107; /* Contour jaune */
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    text-align: center;
    text-transform: uppercase;
    transition: background-color 0.3s;
}

.rules-button:hover {
    background-color: #c91c36;
}

/* MODALE DES R√àGLES */
.rules-modal {
    display: none; /* Masqu√©e par d√©faut */
    position: fixed;
    z-index: 2000; /* Tr√®s haut pour √™tre au-dessus de tout */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.95); /* Fond tr√®s sombre */
    padding-top: 20px;
}

.modal-content-rules {
    position: relative;
    margin: 5% auto; /* Centrer l√©g√®rement */
    padding: 0;
    width: 90%;
    max-width: 800px; /* Taille maximale pour l'image */
}

.modal-content-rules img {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(255, 193, 7, 0.4);
}

.rules-close {
    color: white;
    position: absolute;
    top: -30px; /* D√©placer la croix au-dessus du coin */
    right: 0px;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
    cursor: pointer;
    line-height: 1;
}

.rules-close:hover,
.rules-close:focus {
    color: #ffc107;
    text-decoration: none;
    cursor: pointer;
}

/* Ajustement mobile pour la croix */
@media (max-width: 600px) {
    .rules-close {
        top: -20px;
        right: 10px;
        font-size: 30px;
    }
    .modal-content-rules {
        margin: 10% auto;
    }
}
</style>
</head>
<body>

<header class="main-header">
    <div class="logo-container">
        <h1>Circled Fight <span class="tag">CF</span></h1>
    </div>
    <button id="hamburgerMenu" class="hamburger-menu" aria-controls="mobileHub" aria-expanded="false" aria-label="Ouvrir le menu">‚ò∞</button>
    <nav id="mobileHub" class="mobile-hub" aria-hidden="true">
        <ul>
            <li><a href="index.html">Accueil</a></li>
            <li><a href="dashboard.html">Scores MJ</a></li>
            <li><a href="br_dashboard.html">Scores BR</a></li>
            <li><a href="tournament.html">Tournoi du Week-end</a></li>
            <li><a href="members.html">Membres du Clan</a></li>
            <li><a href="join.html">Nous Rejoindre</a></li>
        </ul>
    </nav>
    <div id="mobileHubBackdrop" class="mobile-hub-backdrop" tabindex="-1" aria-hidden="true"></div>
</header>

<main>
    <div class="carousel" id="carousel">
        <span class="prev">&#10094;</span>
        <span class="next">&#10095;</span>
        <img src="img/MJ.png" class="active" alt="Affiche Tournoi">
        <img src="img/BR.png" alt="Affiche MJ">
        <img src="img/HALLO.png" alt="Affiche MJ">
    </div>

    <button class="rules-button" id="openRulesBtn">
        Consulter les R√®gles du Tournoi MJ
    </button>
    
    <div class="form-container">
        <h2>S'inscrire au tournoi</h2>
        <label for="pseudo">Pseudo In-Game :</label>
        <input type="text" id="pseudo" placeholder="Votre pseudo" required>

        <label for="mode">Mode :</label>
        <select id="mode">
            <option value="MJ">MJ</option>
            <option value="BR">BR</option>
        </select>

        <label for="retard">Commentaires / Retard :</label>
        <textarea id="retard" placeholder="Ex: je serai 10min en retard..." rows="3"></textarea>

        <button id="submitBtn">S'inscrire</button>
    </div>

    <div id="inscrits">
        <h3>Inscriptions de la semaine</h3>

        <div class="mode-card">
            <div class="mode-header">
                <span class="icon">‚öîÔ∏è</span>
                <h4>MJ (<span id="countMJ">0</span>)</h4>
            </div>
            <ul id="inscritsMJ" class="inscrits-list"></ul>
        </div>

        <div class="mode-card">
            <div class="mode-header">
                <span class="icon">üéØ</span>
                <h4>BR (<span id="countBR">0</span>)</h4>
            </div>
            <ul id="inscritsBR" class="inscrits-list"></ul>
        </div>
    </div>
</main>

<div id="rulesModal" class="rules-modal">
  <div class="modal-content-rules">
    <span class="rules-close" id="closeRulesBtn">&times;</span>
    <img src="img/REGLE.png" alt="R√®gles du Tournoi MJ - Circled Fight"> 
  </div>
</div>

<script>
// --- Hamburger menu ---
(function(){
    const btn = document.getElementById('hamburgerMenu');
    const hub = document.getElementById('mobileHub');
    const backdrop = document.getElementById('mobileHubBackdrop');

    function openHub() {
        hub.classList.add('open');
        backdrop.classList.add('visible');
        btn.setAttribute('aria-expanded','true');
        hub.setAttribute('aria-hidden','false');
    }
    function closeHub() {
        hub.classList.remove('open');
        backdrop.classList.remove('visible');
        btn.setAttribute('aria-expanded','false');
        hub.setAttribute('aria-hidden','true');
    }

    btn.addEventListener('click', ()=>{ hub.classList.contains('open') ? closeHub() : openHub(); });
    backdrop.addEventListener('click', closeHub);
})();

// --- Carrousel swipe ---
const carousel = document.getElementById('carousel');
const slides = carousel.querySelectorAll('img');
let current = 0;
function showSlide(index){
    slides.forEach(img => img.classList.remove('active'));
    slides[index].classList.add('active');
}
carousel.querySelector('.prev').addEventListener('click', ()=>{ current = (current -1 + slides.length)%slides.length; showSlide(current); });
carousel.querySelector('.next').addEventListener('click', ()=>{ current = (current +1)%slides.length; showSlide(current); });
// Swipe touch
let startX = 0;
carousel.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
carousel.addEventListener('touchend', e => {
    let endX = e.changedTouches[0].clientX;
    if(endX - startX > 50) current = (current -1 + slides.length)%slides.length;
    else if(startX - endX > 50) current = (current +1)%slides.length;
    showSlide(current);
});

// --- Gestion de la Modale des R√®gles ---
const rulesModal = document.getElementById('rulesModal');
const openRulesBtn = document.getElementById('openRulesBtn');
const closeRulesBtn = document.getElementById('closeRulesBtn');

openRulesBtn.onclick = function() {
  rulesModal.style.display = "block";
}

closeRulesBtn.onclick = function() {
  rulesModal.style.display = "none";
}

window.onclick = function(event) {
  if (event.target == rulesModal) {
    rulesModal.style.display = "none";
  }
}

// --- Formulaire Google Forms et Chargement des inscrits (inchang√©) ---
const submitBtn = document.getElementById('submitBtn');

// Entry IDs Google Form
const entryPseudo = 'entry.1892682717';
const entryMode = 'entry.2094814093';
const entryComment = 'entry.125117687';
const formUrl = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSf_X1vZ1OO0yDvAtZOn1GfBYr8BqhRjLmakvVDsDVrwkte5dQ/formResponse';

submitBtn.onclick = ()=>{
    const pseudo = document.getElementById('pseudo').value.trim();
    const mode = document.getElementById('mode').value;
    const retard = document.getElementById('retard').value.trim();
    if(!pseudo){ alert("Merci de rentrer votre pseudo."); return; }

    const formData = new FormData();
    formData.append(entryPseudo, pseudo);
    formData.append(entryMode, mode);
    formData.append(entryComment, retard);

    fetch(formUrl,{method:'POST', mode:'no-cors', body:formData})
        .then(()=>{ 
            alert("Inscription enregistr√©e !"); 
            document.getElementById('pseudo').value=''; 
            document.getElementById('retard').value='';
            loadInscrits(); 
        })
        .catch(()=>alert("Erreur lors de l'inscription"));
};

// --- Petit parseur CSV robuste (g√®re les guillemets et les doubles guillemets) ---
function parseCSV(text) {
    const rows = [];
    let cur = [];
    let field = '';
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const nc = text[i + 1];

        if (c === '"') {
            if (inQuotes && nc === '"') { field += '"'; i++; continue; }
            inQuotes = !inQuotes;
            continue;
        }
        if (c === '\r') continue;
        if (c === '\n' && !inQuotes) { cur.push(field); rows.push(cur); cur = []; field = ''; continue; }
        if (c === ',' && !inQuotes) { cur.push(field); field = ''; continue; }
        field += c;
    }
    if (field !== '' || cur.length) { cur.push(field); rows.push(cur); }
    return rows;
}

// --- Charger les inscrits depuis Google Sheet (version robuste) ---
async function loadInscrits() {
    const mj = document.getElementById('inscritsMJ');
    const br = document.getElementById('inscritsBR');
    const countMJ = document.getElementById('countMJ');
    const countBR = document.getElementById('countBR');

    mj.innerHTML = '<li>Chargement...</li>';
    br.innerHTML = '<li>Chargement...</li>';

    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS59wx288NLzRRXUDs-6FFWdQxp2XX0FiwNyI2lnOOulTFORfqwA3SmoI7KHjuBvwDVW5J-QQ1GClHV/pub?output=csv';

    try {
        const res = await fetch(sheetUrl);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        console.log('tournament: fetched CSV length=', text.length);

        const rows = parseCSV(text);
        if (!rows || rows.length <= 1) {
            mj.innerHTML = '<li>Aucun inscrit</li>';
            br.innerHTML = '<li>Aucun inscrit</li>';
            countMJ.textContent = '0';
            countBR.textContent = '0';
            return;
        }

        // D√©tecter les indices de colonnes (header pr√©sent en premi√®re ligne)
        const header = rows[0].map(h => (h || '').toString().trim().replace(/^"|"$/g, '').toLowerCase());
        let pseudoIdx = header.findIndex(h => /pseudo|player|name|nom/.test(h));
        let modeIdx = header.findIndex(h => /mode|type|gamemode/.test(h));
        if (pseudoIdx === -1) pseudoIdx = 0;
        if (modeIdx === -1) modeIdx = 1;

        mj.innerHTML = '';
        br.innerHTML = '';

        let nbMJ = 0;
        let nbBR = 0;

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;
            const pseudo = (row[pseudoIdx] || '').toString().trim().replace(/^"|"$/g, '');
            const mode = (row[modeIdx] || '').toString().trim().replace(/^"|"$/g, '').toUpperCase();
            if (!pseudo) continue;

            const li = document.createElement('li');
            li.textContent = pseudo;

            if (mode === 'MJ') { mj.appendChild(li); nbMJ++; }
            else if (mode === 'BR') { br.appendChild(li); nbBR++; }
            else { mj.appendChild(li); }
        }

        countMJ.textContent = nbMJ;
        countBR.textContent = nbBR;

    } catch (err) {
        mj.innerHTML = '<li>Erreur de chargement</li>';
        br.innerHTML = '<li>Erreur de chargement</li>';
        console.error('tournament: loadInscrits error', err);
    }
}

loadInscrits();
</script>

</body>
</html>