<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membres | Circled Fight</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/members.css">
    
    <style>
        /* --- MOTEUR GRAPHIQUE BADGES V2.5 (FINAL) --- */
        
        /* Base Badge */
        .badge {
            position: relative;
            overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.1);
            cursor: default;
            transition: all 0.3s ease;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            margin: 2px;
        }

        /* --- COULEURS & MATI√àRES --- */
        .badge-gold    { background: #ffc107; color: #000; border-color: #ffd700; }
        .badge-red     { background: #b71c1c; color: #fff; }
        .badge-blue    { background: #0d47a1; color: #fff; }
        .badge-green   { background: #1b5e20; color: #fff; }
        .badge-purple  { background: #4a148c; color: #fff; }
        
        /* Sp√©ciaux */
        .badge-obsidian { 
            background: #000; color: #ccc; border: 1px solid #7c4dff; 
            box-shadow: 0 0 5px rgba(124, 77, 255, 0.2);
        }
        .badge-diamond { 
            background: #e3f2fd; color: #0d47a1; border: 1px solid #fff; 
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
        }
        .badge-magma {
            background: linear-gradient(45deg, #b71c1c, #f57f17);
            color: #fff;
        }
        
        /* LE VRAI OR (REAL GOLD) */
        .badge-realgold {
            background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            background-size: 200% 200%;
            color: #222;
            font-weight: 900;
            border: 1px solid #fff;
            text-shadow: 0px 1px 0px rgba(255,255,255,0.4);
            animation: gradientMove 5s ease infinite;
        }

        /* --- EFFETS (ANIMATIONS) --- */
        
        /* 1. PULSE (Respiration) */
        .effect-pulse { animation: pulseAnim 2s infinite; }
        @keyframes pulseAnim {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 4px rgba(255, 255, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        /* 2. √âLECTRIQUE (Vibration + Flash) */
        .effect-electric { animation: electricAnim 0.8s infinite; }
        @keyframes electricAnim {
            0% { transform: translate(0,0); opacity: 1; }
            20% { transform: translate(-1px, 1px); border-color: #fff; }
            40% { transform: translate(1px, -1px); opacity: 0.9; }
            60% { transform: translate(-1px, 0); border-color: transparent; }
            80% { transform: translate(1px, 1px); opacity: 1; }
            100% { transform: translate(0, 0); }
        }

        /* 3. SHINE (Reflet qui passe) */
        .effect-shine::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0) 100%);
            transform: skewX(-25deg);
            animation: shineAnim 3s infinite;
        }
        @keyframes shineAnim {
            0% { left: -100%; }
            20% { left: 200%; }
            100% { left: 200%; }
        }

        /* 4. GLITCH (Bug visuel) */
        .effect-glitch { animation: glitchAnim 2s infinite; }
        @keyframes glitchAnim {
            0% { clip-path: inset(0 0 0 0); transform: translate(0); }
            5% { clip-path: inset(10% 0 80% 0); transform: translate(-2px, 0); }
            10% { clip-path: inset(80% 0 10% 0); transform: translate(2px, 0); filter: hue-rotate(90deg); }
            15% { clip-path: inset(0 0 0 0); transform: translate(0); filter: none; }
            100% { clip-path: inset(0 0 0 0); }
        }

        /* 5. BURN (Lueur intense permanente) */
        .effect-burn {
            box-shadow: 0 0 10px currentColor;
            animation: burnAnim 1.5s alternate infinite;
        }
        @keyframes burnAnim {
            from { box-shadow: 0 0 5px currentColor; }
            to { box-shadow: 0 0 15px currentColor, 0 0 5px #fff; }
        }

        @keyframes gradientMove { 
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- LAYOUT UTILS --- */
        .tools-bar { max-width: 1200px; margin: 20px auto; padding: 0 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-between; }
        .search-box { flex: 1; min-width: 250px; background: #1a1a1a; border: 1px solid #444; color: white; padding: 12px; border-radius: 6px; font-family: 'Rajdhani'; font-size: 1.1rem; }
        .btn-tool { background: #222; color: #ccc; border: 1px solid #444; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-family: 'Rajdhani'; transition: 0.3s; }
        .btn-tool:hover { background: #333; color: var(--codm-yellow); border-color: var(--codm-yellow); }
        
        /* ADMIN PANEL STYLES */
        .current-badges-list { background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .edit-badge-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; flex-wrap: wrap; }
        .edit-badge-row input, .edit-badge-row select { background: #111; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; font-size: 0.8rem; }
        .btn-icon { cursor: pointer; padding: 5px; border: none; border-radius: 4px; font-weight: bold; width: 30px; }
        .btn-save-mini { background: var(--codm-yellow); color: black; }
        .btn-del-mini { background: #ff4444; color: white; }
        
        /* ENCYCLO */
        .encyclopedia-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .encyclo-item { background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .encyclo-desc { font-size: 0.9rem; color: #888; margin-top: 10px; font-style: italic; }

        /* USER HIGHLIGHT */
        .current-user-highlight {
            border: 2px solid var(--codm-yellow) !important;
            background: linear-gradient(145deg, rgba(255, 193, 7, 0.05), #111) !important;
            position: relative; box-shadow: 0 0 15px rgba(255, 193, 7, 0.1);
        }
        /* CORRECTION √âTIQUETTE */
        .current-user-tag {
            position: absolute; top: 0; right: 0;
            background: var(--codm-yellow); color: #000;
            font-size: 0.75rem; font-weight: 900; padding: 4px 12px;
            font-family: 'Orbitron'; border-bottom-left-radius: 12px;
            box-shadow: -2px 2px 10px rgba(255, 193, 7, 0.3); z-index: 10; letter-spacing: 1px;
        }
        .current-user-highlight .status-indicator { top: 35px; right: 10px; }
        .admin-controls-wrapper { max-width: 1200px; margin: 0 auto; padding: 0 20px; text-align: center; }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo-container">
            <h1>Circled Fight <span class="tag">CF</span></h1>
        </div>
        <button id="hamburgerMenu" class="hamburger-menu" aria-label="Menu">‚ò∞</button>
        <nav id="mobileHub" class="mobile-hub">
            <ul>
                <li><a href="index.html">Accueil</a></li>
                <li><a href="dashboard.html">Scores MJ</a></li>
                <li><a href="br_dashboard.html">Scores BR</a></li>
                <li><a href="tournament.html">Tournoi du Week-end</a></li>
                <li><a href="members.html">Membres du Clan</a></li>
                <li><a href="join.html">Nous Rejoindre</a></li>
            </ul>
        </nav>
        <div id="mobileHubBackdrop" class="mobile-hub-backdrop"></div>
    </header>

    <div id="moduleErrorNotice" class="module-error" style="display:none;">
        <div class="module-error-inner">
            <h3>Erreur de script</h3>
            <p>Lance un serveur local.</p>
            <button id="moduleErrorClose">Fermer</button>
        </div>
    </div>

    <main>
        <div style="display:flex; justify-content:flex-end; padding:10px 20px;">
            <button id="logoutBtn" class="btn-logout-corner" style="display:none;">D√âCONNEXION ‚èª</button>
        </div>

        <div id="authLock" class="auth-lock-screen" style="display: none;">
            <div class="lock-icon">üîí</div>
            <div class="lock-title">ACC√àS RESTREINT</div>
            <p class="lock-msg">Identifie-toi pour acc√©der aux dossiers des agents.</p>
            <div class="lock-actions">
                <a href="login.html" class="btn-lock-login" style="text-decoration:none;">S'IDENTIFIER</a>
                <a href="join.html" class="btn-lock-join">NOUS REJOINDRE</a>
            </div>
        </div>

        <div id="membersContent" class="members-container" style="display: none;">
            <div id="adminTrigger" class="admin-controls-wrapper" style="display:none;">
                <button class="btn-admin-main" onclick="openAdminPanel()">‚ö†Ô∏è G√âRER LES BADGES (ADMIN)</button>
            </div>
            
            <div class="tools-bar">
                <input type="text" id="searchInput" class="search-box" placeholder="Rechercher un soldat..." onkeyup="window.filterMembers()">
                <button class="btn-tool" onclick="openEncyclopedia()">üìö Encyclop√©die des Badges</button>
            </div>

            <div class="section-title">
                UNIT√âS DU CLAN
                <span class="member-count" id="memberCount">CHARGEMENT...</span>
            </div>
            
            <div class="members-grid" id="membersGrid"></div>
        </div>
    </main>

    <div id="adminModal" class="admin-modal" style="display: none;">
        <div class="admin-panel-content">
            <h2 style="color: var(--accent-red); font-family: 'Orbitron'; margin-top:0;">PANNEAU ADMIN</h2>
            <p style="color:#888;">Forge de Badges v3.0</p>
            <button onclick="closeAdminPanel()" style="background:transparent; border:1px solid #555; color:white; padding:5px 10px; cursor:pointer; float:right; margin-top:-40px;">FERMER</button>
            
            <input type="text" id="adminSearchInput" placeholder="Chercher un membre pour modifier..." onkeyup="window.filterAdminList()" 
                   style="width:100%; padding:10px; margin-bottom:15px; background:#111; border:1px solid #444; color:white; border-radius:4px; font-family:'Rajdhani';">
            
            <div id="adminPlayerList" style="margin-top:20px; max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="encycloModal" class="admin-modal" style="display: none; z-index: 2000;">
        <div class="admin-panel-content" style="max-width: 800px;">
            <h2 style="color: var(--codm-yellow); font-family: 'Orbitron'; margin-top:0;">ARCHIVES BADGES</h2>
            <p style="color:#888;">R√©pertoire des distinctions et effets.</p>
            <button onclick="document.getElementById('encycloModal').style.display='none'" style="background:transparent; border:1px solid #555; color:white; padding:5px 10px; cursor:pointer; float:right; margin-top:-40px;">FERMER</button>
            <div id="encycloList" class="encyclopedia-grid"></div>
        </div>
    </div>

    <script type="module">
        import { auth, db, collection, getDocs, getDoc, doc, updateDoc, onAuthStateChanged, signOut } from './js/firebase.js';
        import { rawData } from './js/data.js';

        const authLock = document.getElementById('authLock');
        const membersContent = document.getElementById('membersContent');
        const membersGrid = document.getElementById('membersGrid');
        const memberCount = document.getElementById('memberCount');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminTrigger = document.getElementById('adminTrigger');
        const adminPlayerList = document.getElementById('adminPlayerList');
        const encycloList = document.getElementById('encycloList');

        let allMembersCache = [];
        let adminUsersCache = [];
        let currentUserUid = null;

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authLock.style.display = 'none';
                membersContent.style.display = 'block';
                logoutBtn.style.display = 'block';
                currentUserUid = user.uid;
                const userSnap = await getDoc(doc(db, "users", user.uid));
                const userData = userSnap.exists() ? userSnap.data() : {};
                if (userData.pseudo === "Admin") adminTrigger.style.display = 'block';
                else adminTrigger.style.display = 'none';
                await fetchAndCacheMembers();
            } else {
                authLock.style.display = 'flex';
                membersContent.style.display = 'none';
                logoutBtn.style.display = 'none';
                adminTrigger.style.display = 'none';
                currentUserUid = null;
            }
        });

        logoutBtn.addEventListener('click', () => { signOut(auth).then(() => location.reload()); });

        // --- FETCH MEMBERS (GRID) ---
        async function fetchAndCacheMembers() {
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                let members = [];
                querySnapshot.forEach((doc) => { let d = doc.data(); d.uid = doc.id; members.push(d); });
                members.sort((a, b) => (b.cfPoints || 0) - (a.cfPoints || 0));
                
                if (currentUserUid) {
                    const myIndex = members.findIndex(m => m.uid === currentUserUid);
                    if (myIndex > -1) {
                        const myProfile = members.splice(myIndex, 1)[0];
                        members.unshift(myProfile);
                    }
                }
                allMembersCache = members.filter(m => m.pseudo !== "Admin");
                renderGrid(allMembersCache);
            } catch (error) { console.error(error); }
        }

        window.filterMembers = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allMembersCache.filter(m => (m.pseudo || "").toLowerCase().includes(term));
            renderGrid(filtered);
        };

        function renderGrid(membersList) {
            memberCount.innerText = `${membersList.length} DOSSIERS`;
            let html = '';

            if(membersList.length === 0) {
                membersGrid.innerHTML = '<p style="text-align:center; color:#666; width:100%;">Aucun soldat trouv√©.</p>';
                return;
            }

            membersList.forEach(m => {
                const pseudo = m.pseudo || "Soldat";
                const points = m.cfPoints || 0;
                const isMe = (m.uid === currentUserUid);
                const cardClass = isMe ? 'member-card current-user-highlight' : 'member-card';
                const tagHtml = isMe ? '<div class="current-user-tag">IDENTIFI√â</div>' : '';

                const localStats = rawData.find(d => d.name.toLowerCase() === pseudo.toLowerCase());
                let avg = "N/A"; let games = 0; let perfBadges = "";

                if (localStats) {
                    const validScores = localStats.scores.filter(s => typeof s === 'number' && s !== null);
                    games = validScores.length;
                    if (games > 0) avg = (validScores.reduce((a, b) => a + b, 0) / games).toFixed(1);
                    if (games >= 8) perfBadges += `<span class="badge badge-gold">V√âT√âRAN</span>`;
                    else if (games >= 4) perfBadges += `<span class="badge badge-silver">SOLDAT</span>`;
                    if (avg !== "N/A" && avg >= 60) perfBadges += `<span class="badge badge-red">√âLITE</span>`;
                }

                let wealthBadges = '';
                if (points > 10000) wealthBadges += `<span class="badge badge-red">L√âGENDE</span>`;
                else if (points > 5000) wealthBadges += `<span class="badge badge-gold">VIP</span>`;

                let customBadgesHtml = '';
                if (m.customBadges && Array.isArray(m.customBadges)) {
                    m.customBadges.forEach(b => {
                        const effectClass = b.effect ? `effect-${b.effect}` : '';
                        customBadgesHtml += `<span class="badge badge-${b.color} ${effectClass}" title="${b.desc || ''}">${b.text}</span>`;
                    });
                }

                const initials = pseudo.substring(0, 2).toUpperCase();

                html += `
                    <div class="${cardClass}">
                        ${tagHtml}
                        <div class="status-indicator"></div>
                        <div class="card-header">
                            <div class="avatar">${initials}</div>
                            <div class="identity">
                                <h3>${pseudo}</h3>
                                <div class="role">Op√©rateur</div>
                            </div>
                        </div>
                        <div class="badges-container">
                            ${wealthBadges} ${perfBadges} ${customBadgesHtml}
                        </div>
                        <div class="card-stats" style="display:grid; grid-template-columns: 1fr 1fr 1fr; border-top:1px solid #333;">
                            <div class="stat-box" style="border-right:1px solid #333;">
                                <span class="stat-val" style="color:var(--codm-yellow)">${points}</span>
                                <span class="stat-label">CF Points</span>
                            </div>
                            <div class="stat-box" style="border-right:1px solid #333;">
                                <span class="stat-val">${avg}</span>
                                <span class="stat-label">Moyenne</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-val">${games}</span>
                                <span class="stat-label">Missions</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            membersGrid.innerHTML = html;
        }

        // --- ENCYCLOPEDIA ---
        window.openEncyclopedia = () => {
            document.getElementById('encycloModal').style.display = 'block';
            let uniqueBadgesMap = new Map();
            allMembersCache.forEach(m => {
                if(m.customBadges && Array.isArray(m.customBadges)) {
                    m.customBadges.forEach(b => {
                        const key = b.text.toUpperCase();
                        if (!uniqueBadgesMap.has(key) || (!uniqueBadgesMap.get(key).desc && b.desc)) {
                            uniqueBadgesMap.set(key, b);
                        }
                    });
                }
            });

            if (uniqueBadgesMap.size === 0) {
                encycloList.innerHTML = "<p>Aucun badge enregistr√©.</p>";
                return;
            }

            let html = '';
            uniqueBadgesMap.forEach(b => {
                const effectClass = b.effect ? `effect-${b.effect}` : '';
                html += `
                    <div class="encyclo-item">
                        <span class="badge badge-${b.color} ${effectClass}" style="font-size:1rem; padding:5px 10px;">${b.text}</span>
                        <div class="encyclo-desc">${b.desc || "Classifi√©"}</div>
                    </div>
                `;
            });
            encycloList.innerHTML = html;
        };

        // --- ADMIN PANEL & SEARCH ---
        window.openAdminPanel = async () => {
            document.getElementById('adminModal').style.display = 'block';
            await loadAdminPanelData();
        };
        window.closeAdminPanel = () => { document.getElementById('adminModal').style.display = 'none'; };

        async function loadAdminPanelData() {
            const querySnapshot = await getDocs(collection(db, "users"));
            adminUsersCache = [];
            querySnapshot.forEach((doc) => { 
                let d = doc.data(); d.uid = doc.id; adminUsersCache.push(d); 
            });
            adminUsersCache.sort((a, b) => (a.pseudo || "").localeCompare(b.pseudo || ""));
            renderAdminList(adminUsersCache);
        }

        window.filterAdminList = () => {
            const term = document.getElementById('adminSearchInput').value.toLowerCase();
            const filtered = adminUsersCache.filter(m => (m.pseudo || "").toLowerCase().includes(term));
            renderAdminList(filtered);
        };

        function renderAdminList(list) {
            let html = '';
            if(list.length === 0) {
                adminPlayerList.innerHTML = '<p style="color:#666; text-align:center;">Aucun membre trouv√©.</p>';
                return;
            }

            list.forEach(m => {
                if (m.pseudo === "Admin") return;

                let existingBadgesHtml = '';
                if (m.customBadges && Array.isArray(m.customBadges) && m.customBadges.length > 0) {
                    m.customBadges.forEach((b, index) => {
                        existingBadgesHtml += `
                            <div class="edit-badge-row">
                                <input type="text" id="edit-text-${m.uid}-${index}" value="${b.text}" style="width:50px;" placeholder="TXT">
                                <select id="edit-color-${m.uid}-${index}">${getColorsOptions(b.color)}</select>
                                <select id="edit-effect-${m.uid}-${index}">${getEffectsOptions(b.effect)}</select>
                                <input type="text" id="edit-desc-${m.uid}-${index}" value="${b.desc || ''}" placeholder="Desc..." style="width:80px;">
                                <button class="btn-icon btn-save-mini" onclick="window.updateBadge('${m.uid}', ${index})" title="Sauvegarder">üíæ</button>
                                <button class="btn-icon btn-del-mini" onclick="window.deleteBadge('${m.uid}', ${index})" title="Supprimer">‚úï</button>
                            </div>
                        `;
                    });
                } else {
                    existingBadgesHtml = '<div style="font-size:0.8rem; color:#666; margin-bottom:10px;">Aucun badge.</div>';
                }

                html += `
                    <div class="admin-player-row">
                        <span style="color:white; font-weight:bold;">${m.pseudo}</span>
                        <button class="btn-add-badge" onclick="window.toggleBadgeForm('${m.uid}')">G√âRER</button>
                    </div>
                    <div id="form-${m.uid}" class="badge-form">
                        <div class="current-badges-list">
                            ${existingBadgesHtml}
                        </div>
                        <div style="border-top:1px solid #444; padding-top:10px;">
                            <strong style="color:var(--codm-yellow); font-size:0.8rem;">CR√âER UN BADGE :</strong>
                            <div style="display:flex; gap:5px; margin-top:5px; flex-wrap:wrap;">
                                <input type="text" id="newText-${m.uid}" placeholder="NOM" style="width:60px;">
                                <select id="newColor-${m.uid}">${getColorsOptions('gold')}</select>
                                <select id="newEffect-${m.uid}">${getEffectsOptions('')}</select>
                            </div>
                            <input type="text" id="newDesc-${m.uid}" placeholder="Description" style="width:100%; margin-top:5px;">
                            <button onclick="window.addNewBadge('${m.uid}')" style="background:var(--codm-yellow); border:none; color:black; width:100%; margin-top:5px; padding:5px;">AJOUTER</button>
                        </div>
                    </div>
                `;
            });
            adminPlayerList.innerHTML = html;
        }

        // --- UTILS SELECTS ---
        function getColorsOptions(selected) {
            const colors = [
                {v:'gold', l:'Or'}, {v:'realgold', l:'‚ö†Ô∏è VRAI OR'}, 
                {v:'red', l:'Rouge'}, {v:'blue', l:'Bleu'}, 
                {v:'green', l:'Vert'}, {v:'purple', l:'Violet'},
                {v:'obsidian', l:'Obsidian (Noir)'}, {v:'diamond', l:'Diamant'}, {v:'magma', l:'Magma'}
            ];
            return colors.map(c => `<option value="${c.v}" ${selected===c.v?'selected':''}>${c.l}</option>`).join('');
        }

        function getEffectsOptions(selected) {
            const effects = [
                {v:'', l:'Aucun effet'},
                {v:'shine', l:'‚ú® Shine'},
                {v:'electric', l:'‚ö° √âlectrique'},
                {v:'pulse', l:'üíì Pulse'},
                {v:'glitch', l:'üëæ Glitch'},
                {v:'burn', l:'üî• Burn'}
            ];
            return effects.map(e => `<option value="${e.v}" ${selected===e.v?'selected':''}>${e.l}</option>`).join('');
        }

        window.toggleBadgeForm = (uid) => {
            const f = document.getElementById(`form-${uid}`);
            if (f) f.style.display = f.style.display === 'block' ? 'none' : 'block';
        };

        // --- CRUD OPERATIONS ---
        window.addNewBadge = async (uid) => {
            const text = document.getElementById(`newText-${uid}`).value.trim().toUpperCase();
            const color = document.getElementById(`newColor-${uid}`).value;
            const effect = document.getElementById(`newEffect-${uid}`).value;
            const desc = document.getElementById(`newDesc-${uid}`).value.trim();
            if (!text) return alert("Nom vide !");
            try {
                const userRef = doc(db, "users", uid);
                const snap = await getDoc(userRef);
                let currentBadges = snap.data().customBadges || [];
                currentBadges.push({ text, color, effect, desc });
                await updateDoc(userRef, { customBadges: currentBadges });
                await loadAdminPanelData(); await fetchAndCacheMembers();
            } catch (e) { console.error(e); }
        };

        window.updateBadge = async (uid, index) => {
            const newText = document.getElementById(`edit-text-${uid}-${index}`).value.trim().toUpperCase();
            const newColor = document.getElementById(`edit-color-${uid}-${index}`).value;
            const newEffect = document.getElementById(`edit-effect-${uid}-${index}`).value;
            const newDesc = document.getElementById(`edit-desc-${uid}-${index}`).value.trim();
            try {
                const userRef = doc(db, "users", uid);
                const snap = await getDoc(userRef);
                let currentBadges = snap.data().customBadges || [];
                if (index >= 0 && index < currentBadges.length) {
                    currentBadges[index] = { text: newText, color: newColor, effect: newEffect, desc: newDesc };
                    await updateDoc(userRef, { customBadges: currentBadges });
                    alert("Modifi√© !");
                    await fetchAndCacheMembers();
                }
            } catch (e) { console.error(e); }
        };

        window.deleteBadge = async (uid, index) => {
            if(!confirm("Supprimer ?")) return;
            try {
                const userRef = doc(db, "users", uid);
                const snap = await getDoc(userRef);
                let currentBadges = snap.data().customBadges || [];
                if (index >= 0 && index < currentBadges.length) {
                    currentBadges.splice(index, 1);
                    await updateDoc(userRef, { customBadges: currentBadges });
                    await loadAdminPanelData(); await fetchAndCacheMembers();
                }
            } catch (e) { console.error(e); }
        };
        
        window.__membersModuleLoaded = true;
    </script>
    <script>
        (function(){
            const btn = document.getElementById('hamburgerMenu');
            const hub = document.getElementById('mobileHub');
            const backdrop = document.getElementById('mobileHubBackdrop');
            if (btn && hub && backdrop) {
                const close = () => { hub.classList.remove('open'); backdrop.classList.remove('visible'); btn.setAttribute('aria-expanded','false'); };
                btn.addEventListener('click', () => { 
                    if(hub.classList.contains('open')) close(); 
                    else { hub.classList.add('open'); backdrop.classList.add('visible'); btn.setAttribute('aria-expanded','true'); }
                });
                backdrop.addEventListener('click', close);
            }
            setTimeout(() => { if (!window.__membersModuleLoaded) document.getElementById('moduleErrorNotice').style.display = 'block'; }, 1000);
            document.getElementById('moduleErrorClose').addEventListener('click', () => document.getElementById('moduleErrorNotice').style.display='none');
        })();
    </script>
</body>
</html>