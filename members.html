<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membres | Circled Fight</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/members.css">
    
    <style>
        /* --- STYLES ADDITIONNELS POUR CETTE UPDATE --- */
        
        /* Barre de recherche et outils */
        .tools-bar {
            max-width: 1200px; margin: 20px auto; padding: 0 20px;
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between;
        }
        .search-box {
            flex: 1; min-width: 250px;
            background: #1a1a1a; border: 1px solid #444; color: white;
            padding: 12px; border-radius: 6px; font-family: 'Rajdhani'; font-size: 1.1rem;
        }
        .btn-tool {
            background: #222; color: #ccc; border: 1px solid #444;
            padding: 10px 15px; border-radius: 6px; cursor: pointer; font-family: 'Rajdhani';
            transition: 0.3s;
        }
        .btn-tool:hover { background: #333; color: var(--codm-yellow); border-color: var(--codm-yellow); }

        /* Badge clickable */
        .badge { cursor: help; transition: transform 0.2s; }
        .badge:hover { transform: scale(1.1); }

        /* Admin Panel - Liste des badges existants */
        .current-badges-list {
            background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 15px; border-radius: 4px;
        }
        .edit-badge-row {
            display: flex; gap: 5px; margin-bottom: 8px; align-items: center;
        }
        .edit-badge-row input, .edit-badge-row select {
            background: #111; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; font-size: 0.8rem;
        }
        .btn-icon { cursor: pointer; padding: 5px; border: none; border-radius: 4px; font-weight: bold; }
        .btn-save-mini { background: var(--codm-yellow); color: black; }
        .btn-del-mini { background: #ff4444; color: white; }

        /* Modal Encyclop√©die */
        .encyclopedia-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;
        }
        .encyclo-item {
            background: #1a1a1a; padding: 10px; border-radius: 6px; border: 1px solid #333;
        }
        .encyclo-owner { font-size: 0.8rem; color: #888; margin-top: 5px; }

        /* Correction affichage Admin Trigger */
        .admin-controls-wrapper {
            max-width: 1200px; margin: 0 auto; padding: 0 20px; text-align: center;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo-container">
            <h1>Circled Fight <span class="tag">CF</span></h1>
        </div>
        <button id="hamburgerMenu" class="hamburger-menu" aria-label="Menu">‚ò∞</button>
        <nav id="mobileHub" class="mobile-hub">
            <ul>
                <li><a href="index.html">Accueil</a></li>
                <li><a href="dashboard.html">Scores MJ</a></li>
                <li><a href="br_dashboard.html">Scores BR</a></li>
                <li><a href="tournament.html">Tournoi du Week-end</a></li>
                <li><a href="members.html">Membres du Clan</a></li>
                <li><a href="join.html">Nous Rejoindre</a></li>
            </ul>
        </nav>
        <div id="mobileHubBackdrop" class="mobile-hub-backdrop"></div>
    </header>

    <div id="moduleErrorNotice" class="module-error" style="display:none;">
        <div class="module-error-inner">
            <h3>Erreur de script</h3>
            <p>Lance un serveur local pour tester : <code>python -m http.server</code></p>
            <button id="moduleErrorClose">Fermer</button>
        </div>
    </div>

    <main>
        <div style="display:flex; justify-content:flex-end; padding:10px 20px;">
            <button id="logoutBtn" class="btn-logout-corner" style="display:none;">D√âCONNEXION ‚èª</button>
        </div>

        <div id="authLock" class="auth-lock-screen" style="display: none;">
            <div class="lock-icon">üîí</div>
            <div class="lock-title">ACC√àS RESTREINT</div>
            <p class="lock-msg">Identifie-toi pour acc√©der aux dossiers des agents.</p>
            <div class="lock-actions">
                <a href="login.html" class="btn-lock-login" style="text-decoration:none;">S'IDENTIFIER</a>
                <a href="join.html" class="btn-lock-join">NOUS REJOINDRE</a>
            </div>
        </div>

        <div id="membersContent" class="members-container" style="display: none;">
            
            <div id="adminTrigger" class="admin-controls-wrapper" style="display:none;">
                <button class="btn-admin-main" onclick="openAdminPanel()">‚ö†Ô∏è G√âRER LES BADGES (ADMIN)</button>
            </div>

            <div class="tools-bar">
                <input type="text" id="searchInput" class="search-box" placeholder="Rechercher un soldat..." onkeyup="window.filterMembers()">
                <button class="btn-tool" onclick="openEncyclopedia()">üìö Encyclop√©die des Badges</button>
            </div>

            <div class="section-title">
                UNIT√âS DU CLAN
                <span class="member-count" id="memberCount">CHARGEMENT...</span>
            </div>
            
            <div class="members-grid" id="membersGrid"></div>
        </div>
    </main>

    <div id="adminModal" class="admin-modal" style="display: none;">
        <div class="admin-panel-content">
            <h2 style="color: var(--accent-red); font-family: 'Orbitron'; margin-top:0;">PANNEAU ADMIN</h2>
            <p style="color:#888;">Ajouter, modifier ou supprimer les badges.</p>
            <button onclick="closeAdminPanel()" style="background:transparent; border:1px solid #555; color:white; padding:5px 10px; cursor:pointer; float:right; margin-top:-40px;">FERMER</button>
            
            <div id="adminPlayerList" style="margin-top:20px; max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="encycloModal" class="admin-modal" style="display: none; z-index: 2000;">
        <div class="admin-panel-content" style="max-width: 800px;">
            <h2 style="color: var(--codm-yellow); font-family: 'Orbitron'; margin-top:0;">ENCYCLOP√âDIE DES BADGES</h2>
            <p style="color:#888;">Liste de tous les badges d√©cern√©s dans le clan.</p>
            <button onclick="document.getElementById('encycloModal').style.display='none'" style="background:transparent; border:1px solid #555; color:white; padding:5px 10px; cursor:pointer; float:right; margin-top:-40px;">FERMER</button>
            
            <div id="encycloList" class="encyclopedia-grid"></div>
        </div>
    </div>

    <script type="module">
        import { auth, db, collection, getDocs, getDoc, doc, updateDoc, onAuthStateChanged, signOut } from './js/firebase.js';
        import { rawData } from './js/data.js';

        // --- DOM ELEMENTS ---
        const authLock = document.getElementById('authLock');
        const membersContent = document.getElementById('membersContent');
        const membersGrid = document.getElementById('membersGrid');
        const memberCount = document.getElementById('memberCount');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminTrigger = document.getElementById('adminTrigger');
        const adminPlayerList = document.getElementById('adminPlayerList');
        const encycloList = document.getElementById('encycloList');

        let allMembersCache = []; // Stocke tous les membres pour la recherche
        let currentUserIsAdmin = false;

        // --- AUTHENTIFICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authLock.style.display = 'none';
                membersContent.style.display = 'block';
                logoutBtn.style.display = 'block';

                // V√©rif Admin
                const userSnap = await getDoc(doc(db, "users", user.uid));
                const userData = userSnap.exists() ? userSnap.data() : {};
                
                if (userData.pseudo === "Admin") {
                    currentUserIsAdmin = true;
                    adminTrigger.style.display = 'block';
                } else {
                    currentUserIsAdmin = false;
                    adminTrigger.style.display = 'none';
                }

                // Dans tous les cas (Admin ou Membre), on charge la grille
                await fetchAndCacheMembers();

            } else {
                authLock.style.display = 'flex';
                membersContent.style.display = 'none';
                logoutBtn.style.display = 'none';
                adminTrigger.style.display = 'none';
            }
        });

        logoutBtn.addEventListener('click', () => { signOut(auth).then(() => location.reload()); });

        // --- CHARGEMENT & AFFICHAGE ---
        async function fetchAndCacheMembers() {
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                let members = [];
                querySnapshot.forEach((doc) => {
                    let d = doc.data(); 
                    d.uid = doc.id; 
                    members.push(d);
                });

                // Tri par points
                members.sort((a, b) => (b.cfPoints || 0) - (a.cfPoints || 0));
                
                // Cache global pour la recherche
                allMembersCache = members.filter(m => m.pseudo !== "Admin");
                
                renderGrid(allMembersCache);

            } catch (error) { console.error("Erreur chargement:", error); }
        }

        // Fonction globale pour filtrer (appel√©e par l'input HTML)
        window.filterMembers = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allMembersCache.filter(m => 
                (m.pseudo || "").toLowerCase().includes(term)
            );
            renderGrid(filtered);
        };

        function renderGrid(membersList) {
            memberCount.innerText = `${membersList.length} DOSSIERS`;
            let html = '';

            if(membersList.length === 0) {
                membersGrid.innerHTML = '<p style="text-align:center; color:#666; width:100%;">Aucun soldat trouv√©.</p>';
                return;
            }

            membersList.forEach(m => {
                const pseudo = m.pseudo || "Soldat";
                const points = m.cfPoints || 0;
                
                // Stats data.js
                const localStats = rawData.find(d => d.name.toLowerCase() === pseudo.toLowerCase());
                let avg = "N/A"; let games = 0; let perfBadges = "";

                if (localStats) {
                    const validScores = localStats.scores.filter(s => typeof s === 'number' && s !== null);
                    games = validScores.length;
                    if (games > 0) avg = (validScores.reduce((a, b) => a + b, 0) / games).toFixed(1);
                    
                    if (games >= 8) perfBadges += `<span class="badge badge-gold" onclick="alert('Badge Automatique: V√©t√©ran (8+ matchs)')">V√âT√âRAN</span>`;
                    else if (games >= 4) perfBadges += `<span class="badge badge-silver" onclick="alert('Badge Automatique: Soldat (4+ matchs)')">SOLDAT</span>`;
                    if (avg !== "N/A" && avg >= 60) perfBadges += `<span class="badge badge-red" onclick="alert('Badge Automatique: √âlite (Moyenne > 60)')">√âLITE</span>`;
                }

                // Badges Richesse
                let wealthBadges = '';
                if (points > 10000) wealthBadges += `<span class="badge badge-red" onclick="alert('Badge Richesse: L√©gende (>10k CF)')">L√âGENDE</span>`;
                else if (points > 5000) wealthBadges += `<span class="badge badge-gold" onclick="alert('Badge Richesse: VIP (>5k CF)')">VIP</span>`;

                // Badges Custom (avec description au clic)
                let customBadgesHtml = '';
                if (m.customBadges && Array.isArray(m.customBadges)) {
                    m.customBadges.forEach(b => {
                        // On √©chappe les guillemets pour le onclick
                        const safeDesc = (b.desc || "Pas de description").replace(/'/g, "\\'");
                        const safeText = (b.text || "").replace(/'/g, "\\'");
                        customBadgesHtml += `<span class="badge badge-${b.color}" onclick="alert('${safeText} : ${safeDesc}')" title="Cliquez pour voir la description">${b.text}</span>`;
                    });
                }

                const initials = pseudo.substring(0, 2).toUpperCase();

                html += `
                    <div class="member-card">
                        <div class="status-indicator"></div>
                        <div class="card-header">
                            <div class="avatar">${initials}</div>
                            <div class="identity">
                                <h3>${pseudo}</h3>
                                <div class="role">Op√©rateur</div>
                            </div>
                        </div>
                        <div class="badges-container">
                            ${wealthBadges} ${perfBadges} ${customBadgesHtml}
                        </div>
                        <div class="card-stats" style="display:grid; grid-template-columns: 1fr 1fr 1fr; border-top:1px solid #333;">
                            <div class="stat-box" style="border-right:1px solid #333;">
                                <span class="stat-val" style="color:var(--codm-yellow)">${points}</span>
                                <span class="stat-label">CF Points</span>
                            </div>
                            <div class="stat-box" style="border-right:1px solid #333;">
                                <span class="stat-val">${avg}</span>
                                <span class="stat-label">Moyenne</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-val">${games}</span>
                                <span class="stat-label">Missions</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            membersGrid.innerHTML = html;
        }

        // --- ENCYCLOP√âDIE ---
        window.openEncyclopedia = () => {
            document.getElementById('encycloModal').style.display = 'block';
            let allBadges = [];

            allMembersCache.forEach(m => {
                if(m.customBadges && Array.isArray(m.customBadges)) {
                    m.customBadges.forEach(b => {
                        allBadges.push({ ...b, owner: m.pseudo });
                    });
                }
            });

            if (allBadges.length === 0) {
                encycloList.innerHTML = "<p>Aucun badge enregistr√©.</p>";
                return;
            }

            // On affiche tout (on pourrait regrouper par nom, mais voir qui a quoi est sympa)
            let html = '';
            allBadges.forEach(b => {
                html += `
                    <div class="encyclo-item">
                        <span class="badge badge-${b.color}">${b.text}</span>
                        <div style="font-size:0.9rem; color:#ccc; margin-top:5px;">${b.desc || "Aucune description"}</div>
                        <div class="encyclo-owner">D√©tenu par: ${b.owner}</div>
                    </div>
                `;
            });
            encycloList.innerHTML = html;
        };

        // --- ADMIN PANEL LOGIC ---
        window.openAdminPanel = async () => {
            document.getElementById('adminModal').style.display = 'block';
            await loadAdminPanelData();
        };
        window.closeAdminPanel = () => { document.getElementById('adminModal').style.display = 'none'; };

        async function loadAdminPanelData() {
            // Re-fetch pour √™tre s√ªr d'avoir les donn√©es fra√Æches pour l'√©dition
            const querySnapshot = await getDocs(collection(db, "users"));
            let members = [];
            querySnapshot.forEach((doc) => {
                let d = doc.data(); d.uid = doc.id; members.push(d);
            });
            members.sort((a, b) => (a.pseudo || "").localeCompare(b.pseudo || ""));

            let html = '';
            members.forEach(m => {
                if (m.pseudo === "Admin") return;

                let existingBadgesHtml = '';
                if (m.customBadges && Array.isArray(m.customBadges) && m.customBadges.length > 0) {
                    m.customBadges.forEach((b, index) => {
                        existingBadgesHtml += `
                            <div class="edit-badge-row">
                                <input type="text" id="edit-text-${m.uid}-${index}" value="${b.text}" style="width:60px;">
                                <select id="edit-color-${m.uid}-${index}">
                                    <option value="gold" ${b.color === 'gold' ? 'selected' : ''}>Or</option>
                                    <option value="red" ${b.color === 'red' ? 'selected' : ''}>Rouge</option>
                                    <option value="blue" ${b.color === 'blue' ? 'selected' : ''}>Bleu</option>
                                    <option value="green" ${b.color === 'green' ? 'selected' : ''}>Vert</option>
                                    <option value="purple" ${b.color === 'purple' ? 'selected' : ''}>Violet</option>
                                </select>
                                <input type="text" id="edit-desc-${m.uid}-${index}" value="${b.desc || ''}" placeholder="Desc..." style="flex:1;">
                                <button class="btn-icon btn-save-mini" onclick="window.updateBadge('${m.uid}', ${index})" title="Sauvegarder">üíæ</button>
                                <button class="btn-icon btn-del-mini" onclick="window.deleteBadge('${m.uid}', ${index})" title="Supprimer">‚úï</button>
                            </div>
                        `;
                    });
                } else {
                    existingBadgesHtml = '<div style="font-size:0.8rem; color:#666; margin-bottom:10px;">Aucun badge custom.</div>';
                }

                html += `
                    <div class="admin-player-row">
                        <span style="color:white; font-weight:bold;">${m.pseudo}</span>
                        <button class="btn-add-badge" onclick="window.toggleBadgeForm('${m.uid}')">G√âRER</button>
                    </div>
                    
                    <div id="form-${m.uid}" class="badge-form">
                        <div class="current-badges-list">
                            <strong style="color:#aaa; font-size:0.8rem;">BADGES ACTUELS :</strong>
                            ${existingBadgesHtml}
                        </div>

                        <div style="border-top:1px solid #444; padding-top:10px;">
                            <strong style="color:var(--codm-yellow); font-size:0.8rem;">AJOUTER UN NOUVEAU :</strong>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <input type="text" id="newText-${m.uid}" placeholder="NOM (ex: MVP)" style="width:80px;">
                                <select id="newColor-${m.uid}">
                                    <option value="gold">Or</option>
                                    <option value="red">Rouge</option>
                                    <option value="blue">Bleu</option>
                                    <option value="green">Vert</option>
                                    <option value="purple">Violet</option>
                                </select>
                            </div>
                            <input type="text" id="newDesc-${m.uid}" placeholder="Description (ex: Vainqueur S1)" style="width:100%; margin-top:5px;">
                            <button onclick="window.addNewBadge('${m.uid}')" style="background:var(--codm-yellow); border:none; color:black; width:100%; margin-top:5px; padding:5px;">AJOUTER</button>
                        </div>
                    </div>
                `;
            });
            adminPlayerList.innerHTML = html;
        }

        window.toggleBadgeForm = (uid) => {
            const f = document.getElementById(`form-${uid}`);
            if (f) f.style.display = f.style.display === 'block' ? 'none' : 'block';
        };

        // --- CRUD BADGES ---

        // 1. AJOUTER
        window.addNewBadge = async (uid) => {
            const text = document.getElementById(`newText-${uid}`).value.trim().toUpperCase();
            const color = document.getElementById(`newColor-${uid}`).value;
            const desc = document.getElementById(`newDesc-${uid}`).value.trim();

            if (!text) return alert("Le nom du badge est vide !");

            try {
                // On r√©cup√®re le doc actuel
                const userRef = doc(db, "users", uid);
                const snap = await getDoc(userRef);
                let currentBadges = snap.data().customBadges || [];

                // On ajoute le nouveau
                currentBadges.push({ text: text, color: color, desc: desc });

                // On √©crase le tableau
                await updateDoc(userRef, { customBadges: currentBadges });
                
                alert("Badge ajout√© !");
                await loadAdminPanelData(); // Refresh panel
                await fetchAndCacheMembers(); // Refresh grid arri√®re-plan

            } catch (e) { console.error(e); alert("Erreur ajout"); }
        };

        // 2. MODIFIER (UPDATE)
        window.updateBadge = async (uid, index) => {
            const newText = document.getElementById(`edit-text-${uid}-${index}`).value.trim().toUpperCase();
            const newColor = document.getElementById(`edit-color-${uid}-${index}`).value;
            const newDesc = document.getElementById(`edit-desc-${uid}-${index}`).value.trim();

            try {
                const userRef = doc(db, "users", uid);
                const snap = await getDoc(userRef);
                let currentBadges = snap.data().customBadges || [];

                if (index >= 0 && index < currentBadges.length) {
                    currentBadges[index] = { text: newText, color: newColor, desc: newDesc };
                    await updateDoc(userRef, { customBadges: currentBadges });
                    alert("Badge modifi√© !");
                    // On ne refresh pas tout le panel pour √©viter de fermer le volet, juste feedback
                }
            } catch (e) { console.error(e); alert("Erreur modification"); }
        };

        // 3. SUPPRIMER
        window.deleteBadge = async (uid, index) => {
            if(!confirm("Supprimer ce badge d√©finitivement ?")) return;

            try {
                const userRef = doc(db, "users", uid);
                const snap = await getDoc(userRef);
                let currentBadges = snap.data().customBadges || [];

                if (index >= 0 && index < currentBadges.length) {
                    currentBadges.splice(index, 1); // Retire l'√©l√©ment √† l'index
                    await updateDoc(userRef, { customBadges: currentBadges });
                    await loadAdminPanelData(); // Refresh panel pour retirer la ligne
                    await fetchAndCacheMembers();
                }
            } catch (e) { console.error(e); alert("Erreur suppression"); }
        };
        
        window.__membersModuleLoaded = true;
    </script>
    <script>
        // Fallback hamburger script
        (function(){
            const btn = document.getElementById('hamburgerMenu');
            const hub = document.getElementById('mobileHub');
            const backdrop = document.getElementById('mobileHubBackdrop');
            if (btn && hub && backdrop) {
                const close = () => { hub.classList.remove('open'); backdrop.classList.remove('visible'); btn.setAttribute('aria-expanded','false'); };
                btn.addEventListener('click', () => { 
                    if(hub.classList.contains('open')) close(); 
                    else { hub.classList.add('open'); backdrop.classList.add('visible'); btn.setAttribute('aria-expanded','true'); }
                });
                backdrop.addEventListener('click', close);
            }
            setTimeout(() => { if (!window.__membersModuleLoaded) document.getElementById('moduleErrorNotice').style.display = 'block'; }, 1000);
            document.getElementById('moduleErrorClose').addEventListener('click', () => document.getElementById('moduleErrorNotice').style.display='none');
        })();
    </script>
</body>
</html>